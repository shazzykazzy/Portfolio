{% extends "base.html" %}

{% block title %}Sessions - Tutoring Invoicing{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Tutoring Sessions</h2>
    <button class="btn btn-primary" onclick="openSessionModal()">Add Session</button>
</div>

<div class="card">
    <div class="card-body">
        <div class="filter-bar">
            <input type="text" id="session-search" class="form-control" placeholder="Search sessions...">
            <select id="student-filter" class="form-control">
                <option value="">All Students</option>
            </select>
            <select id="invoice-filter" class="form-control">
                <option value="">All Sessions</option>
                <option value="unbilled">Unbilled Only</option>
                <option value="billed">Billed Only</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Duration (hrs)</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Invoice</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-table">
                    <tr>
                        <td colspan="8" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Session Modal -->
<div id="session-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Session</h3>
            <button class="close-btn" onclick="closeSessionModal()">&times;</button>
        </div>
        <form id="session-form" onsubmit="saveSession(event)">
            <div class="modal-body">
                <input type="hidden" id="session-id">
                <div class="form-group">
                    <label for="session-student">Student *</label>
                    <select id="session-student" class="form-control" required onchange="updateHourlyRate()">
                        <option value="">Select a student</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session-date">Session Date *</label>
                    <input type="date" id="session-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="session-duration">Duration (hours) *</label>
                    <input type="number" id="session-duration" class="form-control" step="0.25" min="0.25" required>
                </div>
                <div class="form-group">
                    <label for="session-rate">Hourly Rate (NZD) *</label>
                    <input type="number" id="session-rate" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="session-subject">Subject/Topic</label>
                    <input type="text" id="session-subject" class="form-control">
                </div>
                <div class="form-group">
                    <label for="session-notes">Notes</label>
                    <textarea id="session-notes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeSessionModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Session</button>
            </div>
        </form>
    </div>
</div>

<script>
let sessions = [];
let students = [];

async function loadSessions() {
    try {
        const [sessionsRes, studentsRes] = await Promise.all([
            fetch('/api/sessions'),
            fetch('/api/students')
        ]);

        sessions = await sessionsRes.json();
        students = await studentsRes.json();

        populateStudentFilters();
        renderSessions(sessions);
    } catch (error) {
        console.error('Error loading sessions:', error);
        showToast('Failed to load sessions', 'error');
    }
}

function populateStudentFilters() {
    const studentSelect = document.getElementById('session-student');
    const filterSelect = document.getElementById('student-filter');

    const studentOptions = students.map(s =>
        `<option value="${s.id}">${escapeHtml(s.name)}</option>`
    ).join('');

    studentSelect.innerHTML = '<option value="">Select a student</option>' + studentOptions;
    filterSelect.innerHTML = '<option value="">All Students</option>' + studentOptions;
}

function renderSessions(sessionList) {
    const tbody = document.getElementById('sessions-table');
    if (sessionList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No sessions found</td></tr>';
        return;
    }

    tbody.innerHTML = sessionList.map(session => {
        const amount = session.duration * session.hourly_rate;
        const invoiceText = session.invoice_number || '<span class="badge badge-warning">Unbilled</span>';
        return `
            <tr>
                <td>${formatDate(session.session_date)}</td>
                <td>${escapeHtml(session.student_name)}</td>
                <td>${escapeHtml(session.subject || 'N/A')}</td>
                <td>${session.duration.toFixed(2)}</td>
                <td>NZD $${session.hourly_rate.toFixed(2)}</td>
                <td>NZD $${amount.toFixed(2)}</td>
                <td>${invoiceText}</td>
                <td>
                    <button class="btn btn-sm" onclick="editSession(${session.id})" ${session.invoice_id ? 'disabled' : ''}>Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSession(${session.id})" ${session.invoice_id ? 'disabled' : ''}>Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateHourlyRate() {
    const studentId = parseInt(document.getElementById('session-student').value);
    if (studentId) {
        const student = students.find(s => s.id === studentId);
        if (student) {
            document.getElementById('session-rate').value = student.hourly_rate;
        }
    }
}

function openSessionModal(sessionId = null) {
    const modal = document.getElementById('session-modal');
    const form = document.getElementById('session-form');
    form.reset();

    // Set default date to today
    document.getElementById('session-date').value = new Date().toISOString().split('T')[0];

    if (sessionId) {
        document.getElementById('modal-title').textContent = 'Edit Session';
        const session = sessions.find(s => s.id === sessionId);
        if (session) {
            document.getElementById('session-id').value = session.id;
            document.getElementById('session-student').value = session.student_id;
            document.getElementById('session-date').value = session.session_date;
            document.getElementById('session-duration').value = session.duration;
            document.getElementById('session-rate').value = session.hourly_rate;
            document.getElementById('session-subject').value = session.subject || '';
            document.getElementById('session-notes').value = session.notes || '';
        }
    } else {
        document.getElementById('modal-title').textContent = 'Add Session';
        document.getElementById('session-id').value = '';
    }

    modal.style.display = 'block';
}

function closeSessionModal() {
    document.getElementById('session-modal').style.display = 'none';
}

async function saveSession(event) {
    event.preventDefault();

    const sessionId = document.getElementById('session-id').value;
    const sessionData = {
        student_id: parseInt(document.getElementById('session-student').value),
        session_date: document.getElementById('session-date').value,
        duration: parseFloat(document.getElementById('session-duration').value),
        hourly_rate: parseFloat(document.getElementById('session-rate').value),
        subject: document.getElementById('session-subject').value,
        notes: document.getElementById('session-notes').value
    };

    try {
        const url = sessionId ? `/api/sessions/${sessionId}` : '/api/sessions';
        const method = sessionId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sessionData)
        });

        if (response.ok) {
            showToast(`Session ${sessionId ? 'updated' : 'created'} successfully`, 'success');
            closeSessionModal();
            loadSessions();
        } else {
            showToast('Failed to save session', 'error');
        }
    } catch (error) {
        console.error('Error saving session:', error);
        showToast('Failed to save session', 'error');
    }
}

function editSession(sessionId) {
    openSessionModal(sessionId);
}

async function deleteSession(sessionId) {
    if (!confirm('Are you sure you want to delete this session?')) {
        return;
    }

    try {
        const response = await fetch(`/api/sessions/${sessionId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Session deleted successfully', 'success');
            loadSessions();
        } else {
            showToast('Failed to delete session', 'error');
        }
    } catch (error) {
        console.error('Error deleting session:', error);
        showToast('Failed to delete session', 'error');
    }
}

// Filters
function applyFilters() {
    const searchTerm = document.getElementById('session-search').value.toLowerCase();
    const studentFilter = document.getElementById('student-filter').value;
    const invoiceFilter = document.getElementById('invoice-filter').value;

    const filtered = sessions.filter(session => {
        const matchesSearch = session.student_name.toLowerCase().includes(searchTerm) ||
                            (session.subject && session.subject.toLowerCase().includes(searchTerm));
        const matchesStudent = !studentFilter || session.student_id === parseInt(studentFilter);
        const matchesInvoice = !invoiceFilter ||
                             (invoiceFilter === 'unbilled' && !session.invoice_id) ||
                             (invoiceFilter === 'billed' && session.invoice_id);

        return matchesSearch && matchesStudent && matchesInvoice;
    });

    renderSessions(filtered);
}

document.getElementById('session-search').addEventListener('input', applyFilters);
document.getElementById('student-filter').addEventListener('change', applyFilters);
document.getElementById('invoice-filter').addEventListener('change', applyFilters);

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('session-modal');
    if (event.target === modal) {
        closeSessionModal();
    }
};

// Load sessions on page load
document.addEventListener('DOMContentLoaded', loadSessions);
</script>
{% endblock %}
